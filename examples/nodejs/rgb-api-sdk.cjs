"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const F=require("axios");class R{constructor(e){this.client=e}async getAddress(){return this.client._request("post","/address")}async getBtcBalance(e={}){return this.client._request("post","/btcbalance",e)}async sendBtc(e){return this.client._request("post","/sendbtc",e)}async createUtxos(e={}){return this.client._request("post","/createutxos",e)}async estimateFee(e){return this.client._request("post","/estimatefee",e)}async listOnchainTransactions(e={}){return this.client._request("post","/listtransactions",e)}async listUnspents(e={}){return this.client._request("post","/listunspents",e)}}class N{constructor(e){this.client=e,this.rgbTransactionSubscriptions=new Map,this.rgbTransactionPollingIntervals=new Map}async getAssetBalance(e){return this.client._request("post","/assetbalance",e)}async getAssetMetadata(e){return this.client._request("post","/assetmetadata",e)}async listAssets(e={}){const t={filter_asset_schemas:e.filter_asset_schemas};return this.client._request("post","/listassets",t)}async listTransactions(e={}){return this.client._request("post","/listtransfers",e)}async issueAssetCfa(e){return this.client._request("post","/issueassetcfa",e)}async issueAssetNia(e){return this.client._request("post","/issueassetnia",e)}async issueAssetUda(e){return this.client._request("post","/issueassetuda",e)}async sendAsset(e){return this.client._request("post","/sendasset",e)}async createRgbInvoice(e){const t={asset_id:e.asset_id,duration_seconds:e.duration_seconds,min_confirmations:e.min_confirmations};return this.client._request("post","/rgbinvoice",t)}async payRgbInvoice(e){const t=await this.decodeRgbInvoice({invoice:e.invoice}),r={recipient_id:t.recipient_id,asset_id:e.asset_id||t.asset_id,amount:e.amount||t.amount,fee_rate:e.fee_rate,skip_sync:e.skip_sync,donation:e.donation||!1,min_confirmations:e.min_confirmations||1,transport_endpoints:e.transport_endpoints||t.transport_endpoints||[]};return this.sendAsset(r)}async decodeRgbInvoice(e){return this.client._request("post","/decodergbinvoice",e)}async failTransfers(e){return this.client._request("post","/failtransfers",e)}async getAssetMedia(e){return this.client._request("post","/getassetmedia",e)}async refreshTransfers(e={}){const t={skip_sync:e.skip_sync};return this.client._request("post","/refreshtransfers",t)}async syncRgbWallet(){return this.client._request("post","/sync",{})}async postAssetMedia(e){const t=new FormData;return t.append("file",e.file),this.client._request("post","/postassetmedia",t)}subscribeToRgbTransactions(e){const{onTransaction:t,onError:r,pollingInterval:l=5e3,maxStoredIds:u=1e3,skipInitialFetch:p=!1}=e;if(!t||typeof t!="function")throw new Error("onTransaction callback is required and must be a function");l<1e3&&console.warn("Warning: Polling interval less than 1000ms may cause performance issues");const g=`rgb-tx-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;let b=Date.now();const i=new Set,a=new Map,d=o=>typeof o=="string"?new Date(o).getTime():o||0,f=()=>{if(i.size<=u)return;[...a.entries()].sort((c,_)=>c[1]-_[1]).map(c=>c[0]).slice(0,i.size-u).forEach(c=>{i.delete(c),a.delete(c)})};p||this.listTransactions().then(o=>{o&&o.transfers&&Array.isArray(o.transfers)&&(o.transfers.forEach(n=>{i.add(n.idx),a.set(n.idx,d(n.created_at))}),f())}).catch(o=>{r&&typeof r=="function"&&r(o)});let m=l,y=0;const s=setInterval(async()=>{try{const o=await this.listTransactions();if(o&&o.transfers&&Array.isArray(o.transfers)){const n=o.transfers.filter(c=>{if(!i.has(c.idx))return i.add(c.idx),a.set(c.idx,d(c.created_at)),!0;const _=d(c.created_at);return i.has(c.idx)&&_>(a.get(c.idx)||0)?(a.set(c.idx,_),!0):!1});if(o.transfers.length>0){const c=Math.max(...o.transfers.map(_=>d(_.created_at)));b=Math.max(b,c)}if(f(),n.length>0)n.forEach(c=>{t(c)}),y=0;else if(y++,y>5){const c=Math.min(l*3,l*(1+y/10));if(c!==m){m=c,clearInterval(s);const _=setInterval(s.callback,m);this.rgbTransactionPollingIntervals.set(g,_)}}}}catch(o){r&&typeof r=="function"&&r(o)}},l);return s.callback=s._onTimeout,this.rgbTransactionSubscriptions.set(g,{onTransaction:t,onError:r,pollingInterval:l,currentPollingInterval:m,maxStoredIds:u}),this.rgbTransactionPollingIntervals.set(g,s),g}unsubscribeFromRgbTransactions(e){if(!this.rgbTransactionSubscriptions.has(e))return!1;const t=this.rgbTransactionPollingIntervals.get(e);return t&&(clearInterval(t),this.rgbTransactionPollingIntervals.delete(e)),this.rgbTransactionSubscriptions.delete(e),!0}}var I={},S;function B(){if(S)return I;S=1,Object.defineProperty(I,"__esModule",{value:!0}),I.bech32m=I.bech32=void 0;const h="qpzry9x8gf2tvdw0s3jn54khce6mua7l",e={};for(let i=0;i<h.length;i++){const a=h.charAt(i);e[a]=i}function t(i){const a=i>>25;return(i&33554431)<<5^-(a>>0&1)&996825010^-(a>>1&1)&642813549^-(a>>2&1)&513874426^-(a>>3&1)&1027748829^-(a>>4&1)&705979059}function r(i){let a=1;for(let d=0;d<i.length;++d){const f=i.charCodeAt(d);if(f<33||f>126)return"Invalid prefix ("+i+")";a=t(a)^f>>5}a=t(a);for(let d=0;d<i.length;++d){const f=i.charCodeAt(d);a=t(a)^f&31}return a}function l(i,a,d,f){let m=0,y=0;const s=(1<<d)-1,o=[];for(let n=0;n<i.length;++n)for(m=m<<a|i[n],y+=a;y>=d;)y-=d,o.push(m>>y&s);if(f)y>0&&o.push(m<<d-y&s);else{if(y>=a)return"Excess padding";if(m<<d-y&s)return"Non-zero padding"}return o}function u(i){return l(i,8,5,!0)}function p(i){const a=l(i,5,8,!1);if(Array.isArray(a))return a}function g(i){const a=l(i,5,8,!1);if(Array.isArray(a))return a;throw new Error(a)}function b(i){let a;i==="bech32"?a=1:a=734539939;function d(s,o,n){if(n=n||90,s.length+7+o.length>n)throw new TypeError("Exceeds length limit");s=s.toLowerCase();let c=r(s);if(typeof c=="string")throw new Error(c);let _=s+"1";for(let w=0;w<o.length;++w){const T=o[w];if(T>>5!==0)throw new Error("Non 5-bit word");c=t(c)^T,_+=h.charAt(T)}for(let w=0;w<6;++w)c=t(c);c^=a;for(let w=0;w<6;++w){const T=c>>(5-w)*5&31;_+=h.charAt(T)}return _}function f(s,o){if(o=o||90,s.length<8)return s+" too short";if(s.length>o)return"Exceeds length limit";const n=s.toLowerCase(),c=s.toUpperCase();if(s!==n&&s!==c)return"Mixed-case string "+s;s=n;const _=s.lastIndexOf("1");if(_===-1)return"No separator character for "+s;if(_===0)return"Missing prefix for "+s;const w=s.slice(0,_),T=s.slice(_+1);if(T.length<6)return"Data too short";let q=r(w);if(typeof q=="string")return q;const x=[];for(let k=0;k<T.length;++k){const M=T.charAt(k),P=e[M];if(P===void 0)return"Unknown character "+M;q=t(q)^P,!(k+6>=T.length)&&x.push(P)}return q!==a?"Invalid checksum for "+s:{prefix:w,words:x}}function m(s,o){const n=f(s,o);if(typeof n=="object")return n}function y(s,o){const n=f(s,o);if(typeof n=="object")return n;throw new Error(n)}return{decodeUnsafe:m,decode:y,encode:d,toWords:u,fromWordsUnsafe:p,fromWords:g}}return I.bech32=b("bech32"),I.bech32m=b("bech32m"),I}var H=B();const L=1,$=13,z=19,O=23,j=6,W=24,Y=16,X=27,V=5,K=30,J=31,Q={bc:"Mainnet",tb:"Testnet",bcrt:"Regtest",sb:"Signet",tbs:"Signet"},Z={m:.001,u:1e-6,n:1e-9,p:1e-12};function E(h){let e=0;for(const t of h)e=e*32+t;return e}function v(h){const e=[];let t=0,r=0;for(const l of h)for(t=t<<5|l,r+=5;r>=8;)e.push(t>>>r-8&255),r-=8;return new Uint8Array(e)}function A(h){return Array.from(h).map(e=>e.toString(16).padStart(2,"0")).join("")}function ee(h){const e=h.match(/^ln([a-z]+)(\d*)([munp]?)$/);if(!e)throw new Error("Invalid HRP format");const[,t,r,l]=e;return{currency:t,amount:r?parseInt(r):null,siPrefix:l||null,network:Q[t]||"Unknown"}}function te(h){const e={};let t=0;for(;t<h.length;){if(t+3>h.length)throw new Error("Unexpected end of tagged fields");const r=h[t],l=h[t+1]<<5|h[t+2];if(t+=3,t+l>h.length)throw new Error("Tagged field length exceeds remaining data");const u=h.slice(t,t+l);t+=l;try{switch(r){case L:u.length===52&&(e.paymentHash=A(v(u)));break;case $:const p=v(u);e.description=new TextDecoder().decode(p);break;case z:u.length===53&&(e.payeePubkey=A(v(u)));break;case O:u.length===52&&(e.descriptionHash=A(v(u)));break;case j:e.expiryTime=E(u);break;case W:e.minFinalCltvExpiryDelta=E(u);break;case Y:u.length===52&&(e.paymentSecret=A(v(u)));break;case X:e.paymentMetadata=A(v(u));break;case V:e.features=A(v(u));break;case K:e.rgbAmount=E(u);break;case J:const g=v(u);e.rgbContractId=new TextDecoder().decode(g);break;default:break}}catch{continue}}return e}function se(h){try{const e=H.bech32.decode(h,2e3),{prefix:t,words:r}=e,l=ee(t);if(r.length<111)throw new Error("Invoice data too short");const u=r.slice(0,7),p=E(u),g=r.slice(7,r.length-104),b=te(g);let i=null;if(l.amount!==null){let f=l.amount;l.siPrefix&&Z[l.siPrefix]?l.siPrefix==="u"?i=f*1e5:l.siPrefix==="m"?i=f*1e8:l.siPrefix==="n"?i=f*100:l.siPrefix==="p"&&(i=Math.floor(f/10)):i=Math.floor(f/10)}const a=b.expiryTime||3600;let d=null;return b.rgbContractId&&(d=b.rgbContractId),{amt_msat:i,expiry_sec:a,timestamp:p,asset_id:d,asset_amount:b.rgbAmount||null,payment_hash:b.paymentHash||null,payment_secret:b.paymentSecret||null,payee_pubkey:b.payeePubkey||null,network:l.network}}catch(e){throw new Error(`Failed to decode Lightning invoice: ${e.message}`)}}class D{constructor(e){this.client=e,this.paymentSubscriptions=new Map,this.paymentPollingIntervals=new Map}async connectPeer(e){return this.client._request("post","/connectpeer",e)}async listPeers(){return this.client._request("get","/listpeers")}async disconnectPeer(e){return this.client._request("post","/disconnectpeer",e)}async openChannel(e){return this.client._request("post","/openchannel",e)}async closeChannel(e){return this.client._request("post","/closechannel",e)}async listChannels(){return this.client._request("get","/listchannels")}async getChannelIdByTempId(e){return this.client._request("post","/getchannelid",e)}async createInvoice(e){return this.client._request("post","/lninvoice",e)}async payInvoice(e){return this.client._request("post","/sendpayment",e)}async decodeLnInvoice(e){return this.client._request("post","/decodelninvoice",e)}async getInvoiceStatus(e){return this.client._request("post","/invoicestatus",e)}async getPayment(e){return this.client._request("post","/getpayment",e)}async listPayments(){return this.client._request("get","/listpayments")}async keysend(e){return this.client._request("post","/keysend",e)}subscribeToPastPayments(e){const{onPayment:t,onError:r,pollingInterval:l=5e3,maxStoredIds:u=1e3,skipInitialFetch:p=!1}=e;if(!t||typeof t!="function")throw new Error("onPayment callback is required and must be a function");l<1e3&&console.warn("Warning: Polling interval less than 1000ms may cause performance issues");const g=`payment-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;let b=Date.now();const i=new Set,a=new Map,d=()=>{if(i.size<=u)return;[...a.entries()].sort((n,c)=>n[1]-c[1]).map(n=>n[0]).slice(0,i.size-u).forEach(n=>{i.delete(n),a.delete(n)})};p||this.listPayments().then(s=>{s&&s.payments&&Array.isArray(s.payments)&&(s.payments.forEach(o=>{i.add(o.payment_hash),a.set(o.payment_hash,o.created_at||Date.now())}),d())}).catch(s=>{r&&typeof r=="function"&&r(s)});let f=l,m=0;const y=setInterval(async()=>{try{const s=await this.listPayments();if(s&&s.payments&&Array.isArray(s.payments)){const o=s.payments.filter(n=>i.has(n.payment_hash)?i.has(n.payment_hash)&&n.updated_at>(a.get(n.payment_hash)||0)?(a.set(n.payment_hash,n.updated_at||Date.now()),!0):!1:(i.add(n.payment_hash),a.set(n.payment_hash,n.created_at||Date.now()),!0));if(s.payments.length>0){const n=Math.max(...s.payments.map(c=>c.updated_at||0));b=Math.max(b,n)}if(d(),o.length>0)o.forEach(n=>{t(n)}),m=0;else if(m++,m>5){const n=Math.min(l*3,l*(1+m/10));if(n!==f){f=n,clearInterval(y);const c=setInterval(y.callback,f);this.paymentPollingIntervals.set(g,c)}}}}catch(s){r&&typeof r=="function"&&r(s)}},l);return y.callback=y._onTimeout,this.paymentSubscriptions.set(g,{onPayment:t,onError:r,pollingInterval:l,currentPollingInterval:f,maxStoredIds:u}),this.paymentPollingIntervals.set(g,y),g}unsubscribeFromPayments(e){if(!this.paymentSubscriptions.has(e))return!1;const t=this.paymentPollingIntervals.get(e);return t&&(clearInterval(t),this.paymentPollingIntervals.delete(e)),this.paymentSubscriptions.delete(e),!0}decodeRGBLNInvoice(e){return se(e)}}class C{constructor(e){this.client=e}async makerInitSwap(e){return this.client._request("post","/makerinit",e)}async makerExecuteSwap(e){return this.client._request("post","/makerexecute",e)}async takerAcceptSwap(e){return this.client._request("post","/taker",e)}async getSwap(e){return this.client._request("post","/getswap",e)}async listSwaps(){return this.client._request("get","/listswaps")}}class U{constructor(e){this.client=e}async getNodeInfo(){return this.client._request("get","/nodeinfo")}async getNodeState(){try{const e=await this.client._request("get","/nodestate");return e==null?void 0:e.state}catch(e){if(e.message.includes("Network Error"))return 0;throw e}}async getNetworkInfo(){return this.client._request("get","/networkinfo")}async checkIndexerUrl(e){return this.client._request("post","/checkindexerurl",e)}async checkProxyEndpoint(e){return this.client._request("post","/checkproxyendpoint",e)}async sendOnionMessage(e){return this.client._request("post","/sendonionmessage",e)}async signMessage(e){return this.client._request("post","/signmessage",e)}async initNode(e){return this.client._request("post","/init",e)}async unlockNode(e){return this.client._request("post","/unlock",e)}async lockNode(){return this.client._request("post","/lock")}async changePassword(e){return this.client._request("post","/changepassword",e)}async backupNode(e){return this.client._request("post","/backup",e)}async restoreNode(e){return this.client._request("post","/restore",e)}}class G{constructor(e={},t=null){let r={};typeof e=="string"?(r.baseUrl=e,t&&(r.headers={Authorization:`Bearer ${t}`})):r=e,this.baseUrl=r.baseUrl||"http://localhost:3001",this.axios=F.create({baseURL:this.baseUrl,headers:{"Content-Type":"application/json",...r.headers},...r.axiosConfig}),this.onchain=new R(this),this.rgb=new N(this),this.lightning=new D(this),this.swaps=new C(this),this.node=new U(this)}async _request(e,t,r=null){var l,u;try{const p={method:e,url:t};return r!==null&&(e==="post"||e==="put"||e==="patch")?p.data=r:r!==null&&e==="get"&&(p.params=r),(await this.axios.request(p)).data}catch(p){if(p.response){const g=((l=p.response.data)==null?void 0:l.message)||((u=p.response.data)==null?void 0:u.error)||p.response.statusText;throw new Error(`API Error (${p.response.status}): ${g}`)}else throw p.request?new Error(`Network Error: Unable to reach RGB API at ${this.baseUrl}`):new Error(`Request Error: ${p.message}`)}}}exports.LightningMethods=D;exports.NodeMethods=U;exports.OnchainMethods=R;exports.RgbApiClient=G;exports.RgbMethods=N;exports.SwapMethods=C;exports.default=G;
//# sourceMappingURL=rgb-api-sdk.cjs.map
